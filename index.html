<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = 'taplist.json';
  const UPDATE_URL = '/update-beer-status';
  
  const beerGrid = document.getElementById('beerGrid');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const venueNameEl = document.getElementById('venueName');
  const searchEl = document.getElementById('search');
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminLoginModal');
  
  let taplist = null;
  let isAdmin = sessionStorage.getItem('isAdmin') === 'true';

  // ---- Helpers ----
  function escapeHtml(s) {
    return (s === undefined || s === null) ? '' : String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[c]));
  }

  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2,'0'))
                .join('');
  }

  // ---- Render taplist ----
  function renderTaplist(data){
    if(!data) return;
    taplist = data;
    venueNameEl.textContent = data.meta?.venue ?? 'Prairie Sun Brewery';
    lastUpdatedEl.textContent = 'Updated: ' + (data.meta?.last_updated ?? '—');

    const beers = (data.beers||[]).slice().sort((a,b)=> (a.sort_order||999)-(b.sort_order||999));
    beerGrid.innerHTML = '';

    for(const beer of beers){
      const card = document.createElement('article');
      card.className = 'card';

      const toggleHTML = isAdmin ? `
        <div style="margin-top:8px; display:flex; align-items:center; gap:8px">
          <label class="toggle">
            <input type="checkbox" ${beer.on_tap?'checked':''} onchange="toggleBeer('${beer.id}', this.checked)" />
            <span class="slider"></span>
          </label>
          <span class="toggle-label">${beer.on_tap?'On tap':'Not on'}</span>
        </div>` :
        (beer.on_tap ? `<div class="on-tap">On tap</div>` : `<div class="pill">Not on</div>`);

      card.innerHTML = `
        <h3>${escapeHtml(beer.name)}
          ${beer.style?`<span style="font-weight:400; font-size:0.86rem; color:var(--muted)">— ${escapeHtml(beer.style)}</span>`:''}
        </h3>
        <div style="font-size:0.85rem; color:var(--muted); margin-top:2px">
          ${escapeHtml(beer.producer||'')}${beer.location?', '+escapeHtml(beer.location):''}
        </div>
        <div class="meta-row">
          <div class="pill">ABV: ${beer.abv??'—'}%</div>
          ${beer.ibu?`<div class="pill">IBU: ${beer.ibu}</div>`:''}
          ${toggleHTML}
        </div>
        <p style="margin-top:8px; color:var(--muted); font-size:0.95rem">${escapeHtml(beer.description||'')}</p>
        <div class="sizes">${(beer.sizes||[]).map(s=>`<div class="size">${escapeHtml(s.label)} — $${Number(s.price).toFixed(2)}</div>`).join('')}</div>
        <div class="tags">${(beer.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
      `;
      beerGrid.appendChild(card);
    }
  }

  // ---- Toggle handler ----
  async function toggleBeer(beerId,onTap){
    try{
      await fetch(UPDATE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({beerId,onTap})
      });
      const input = document.querySelector(`input[type="checkbox"][onchange*="'${beerId}'"]`);
      if(input){
        const label = input.closest('div').querySelector('.toggle-label');
        if(label) label.textContent = onTap?'On tap':'Not on';
      }
    } catch(err){ console.error(err); alert('Failed to update beer status'); }
  }

  // ---- Search (debounced) ----
  let debounceTimer;
  searchEl.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      if(!taplist) return;
      const term = searchEl.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const filteredBeers = (taplist.beers||[]).filter(beer=>{
        const name = (beer.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const style = (beer.style||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const tags = (beer.tags||[]).map(t=>t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""));
        return name.includes(term) || style.includes(term) || tags.some(tag=>tag.includes(term));
      });
      renderTaplist({...taplist, beers:filteredBeers});
    },200);
  });

  // ---- Refresh ----
  document.getElementById('refresh').addEventListener('click', () => {
    searchEl.value = '';
    fetch(API_URL).then(r=>r.json()).then(data => { taplist = data; renderTaplist(taplist); });
  });

  // ---- Admin login modal ----
  adminBtn.addEventListener('click', () => {
    adminModal.style.display = 'flex';
  });

  document.getElementById('adminLoginBtn').onclick = async () => {
    const input = document.getElementById('adminPasswordInput').value;
    const inputHash = await sha256(input);
    const ADMIN_PASSWORD_HASH = "fa9fdcce5d12f32fd2018b3ca1299fea52be175ed53930e04203a4eed7480158"; // hash of "beertastegood"

    if(inputHash === ADMIN_PASSWORD_HASH){
      isAdmin = true;
      sessionStorage.setItem('isAdmin','true');
      adminModal.style.display = 'none';
      renderTaplist(taplist);
      adminBtn.style.display = 'none'; // hide Admin button after login
    } else {
      document.getElementById('adminLoginError').style.display = 'block';
    }
  };

  // ---- Initial fetch + WebSocket ----
  fetch(API_URL).then(r=>r.json()).then(renderTaplist);

  let socket;
  function connectSocket(){
    socket = new WebSocket(`ws://${location.host}`);
    socket.onmessage = e => {
      const msg = JSON.parse(e.data);
      if(msg.type==='taplist-update') renderTaplist(msg.taplist);
    };
    socket.onclose = () => setTimeout(connectSocket,3000);
  }
  connectSocket();

  // ---- PWA service worker ----
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg=>console.log('Service worker registered:',reg.scope))
        .catch(err=>console.error('Service worker registration failed:',err));
    });
  }
});
</script>

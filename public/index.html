<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#6b3e1b" />
<title>Prairie Sun Brewery — Live Taplist</title>
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icons/icon-192.png" sizes="192x192" />
<style>
:root {
  --bg:#fbfbfb; --card:#fff; --accent:#6b3e1b; --muted:#666; --gap:12px;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
html,body{height:100%; margin:0; background:var(--bg); color:#111}
header{background:linear-gradient(90deg,var(--accent),#8b5a32); color:white; padding:18px 14px;}
header h1{margin:0; font-size:1.15rem; letter-spacing:0.6px}
header p{margin:6px 0 0 0; font-size:0.9rem; opacity:0.95}
.container{padding:14px; max-width:900px; margin:0 auto}
.meta{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap}
.meta .updated{color:var(--muted); font-size:0.9rem}
input[type=search]{padding:8px 12px; border-radius:8px; border:1px solid #ddd; width:100%; max-width:340px}
.grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:var(--gap)}
.card{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 1px 6px rgba(0,0,0,0.06)}
.card h3{margin:0; font-size:1.02rem}
.meta-row{display:flex; gap:8px; align-items:center; margin-top:6px}
.pill{background:#eee; padding:4px 8px; border-radius:999px; font-size:0.85rem}
.on-tap{background:#dff5e1; color:#196619; font-weight:600; padding:4px 8px; border-radius:8px}
.tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
.tag{font-size:0.78rem; color:var(--muted); background:#f6f6f6; padding:4px 8px; border-radius:999px}
.sizes{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
.size{font-weight:700}
footer{padding:12px; color:var(--muted); text-align:center; font-size:0.9rem}
.tv-note{display:none}
@media (min-width:900px){ header h1{font-size:1.35rem} .tv-note{display:block; font-size:0.9rem; color:#fff; opacity:0.9} }

/* iPhone-style toggle */
.toggle { position: relative; display: inline-block; width: 50px; height: 28px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left:0; right:0; bottom:0; background-color: #ccc; transition:0.4s; border-radius:28px; }
.slider:before { position:absolute; content:""; height:22px; width:22px; left:3px; bottom:3px; background:white; transition:0.4s; border-radius:50%; }
.toggle input:checked + .slider { background-color: #4caf50; }
.toggle input:checked + .slider:before { transform: translateX(22px); }
.toggle-label { margin-left:6px; font-size:0.85rem; color:var(--muted); }

/* Admin Login Modal */
#adminLoginModal {
  display: none;
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  justify-content: center; align-items: center;
}
#adminLoginModalContent {
  background: #fff; padding: 20px; border-radius: 12px; max-width: 300px; width: 90%;
  display: flex; flex-direction: column; gap: 12px;
}
#adminLoginError { color: red; display:none; font-size:0.9rem; }
</style>
</head>
<body>

<header>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; max-width:900px; margin:0 auto;">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="icons/icon-192.png" alt="Prairie Sun Brewery Logo" style="height:50px; width:auto; border-radius:6px;" />
      <div>
        <h1>Prairie Sun Brewery — Live Taplist</h1>
        <p class="tv-note">Open the menu on a phone — staff can update taps in seconds.</p>
      </div>
    </div>
    <button id="adminBtn" style="padding:6px 12px; border-radius:6px; border:none; background:var(--accent); color:white; cursor:pointer;">Admin</button>
  </div>
</header>

<div class="container">
  <div class="meta">
    <div>
      <div class="venue" id="venueName">Prairie Sun Brewery</div>
      <div class="updated" id="lastUpdated">Updated: —</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="search" type="search" placeholder="Search beers, styles or tags" />
      <button id="refresh">Refresh</button>
    </div>
  </div>

  <div id="beerGrid" class="grid" aria-live="polite"></div>

  <footer>
    <div id="status">Loading menu…</div>
    <div style="margin-top:6px; font-size:0.85rem">Scan QR around the taproom for this live menu.</div>
  </footer>
</div>

<!-- Admin login modal -->
<div id="adminLoginModal">
  <div id="adminLoginModalContent">
    <h3>Admin Login</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter password" />
    <button id="adminLoginBtn">Login</button>
    <div id="adminLoginError">Incorrect password</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = 'taplist.json';
  const UPDATE_URL = '/update-beer-status';

  const beerGrid = document.getElementById('beerGrid');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const venueNameEl = document.getElementById('venueName');
  const searchEl = document.getElementById('search');
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminLoginModal');

  let taplist = null;
  let isAdmin = sessionStorage.getItem('isAdmin') === 'true';

  // ---- Helpers ----
  function escapeHtml(s) {
    return (s === undefined || s === null) ? '' : String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
    }[c]));
  }

  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2,'0'))
      .join('');
  }

  async function toggleBeer(beerId,onTap){
    try {
      await fetch(UPDATE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({beerId,onTap})
      });
    } catch(err){ console.error(err); alert('Failed to update beer status'); }
  }

  // ---- Render taplist ----
  function renderTaplist(data){
    if(!data) return;
    taplist = data;
    venueNameEl.textContent = data.meta?.venue ?? 'Prairie Sun Brewery';
    lastUpdatedEl.textContent = 'Updated: ' + (data.meta?.last_updated ?? '—');

    const beers = (data.beers||[]).slice().sort((a,b)=> (a.sort_order||999)-(b.sort_order||999));
    beerGrid.innerHTML = '';

    for(const beer of beers){
      const card = document.createElement('article');
      card.className = 'card';

      // Title and style
      const h3 = document.createElement('h3');
      h3.innerHTML = escapeHtml(beer.name) + (beer.style ? `<span style="font-weight:400; font-size:0.86rem; color:var(--muted)"> — ${escapeHtml(beer.style)}</span>` : '');
      card.appendChild(h3);

      // Producer / location
      const producerDiv = document.createElement('div');
      producerDiv.style = "font-size:0.85rem; color:var(--muted); margin-top:2px";
      producerDiv.textContent = escapeHtml(beer.producer || '') + (beer.location ? ', ' + escapeHtml(beer.location) : '');
      card.appendChild(producerDiv);

      // Meta row
      const metaRow = document.createElement('div');
      metaRow.className = 'meta-row';

      const abv = document.createElement('div');
      abv.className = 'pill';
      abv.textContent = `ABV: ${beer.abv ?? '—'}%`;
      metaRow.appendChild(abv);

      if(beer.ibu){
        const ibu = document.createElement('div');
        ibu.className = 'pill';
        ibu.textContent = `IBU: ${beer.ibu}`;
        metaRow.appendChild(ibu);
      }

      if(isAdmin){
        const toggleDiv = document.createElement('div');
        toggleDiv.style = 'display:flex; align-items:center; gap:8px';

        const label = document.createElement('label');
        label.className = 'toggle';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = beer.on_tap;
        input.addEventListener('change', () => {
          toggleBeer(beer.id, input.checked);
          toggleLabel.textContent = input.checked ? 'On tap' : 'Not on';
        });

        const slider = document.createElement('span');
        slider.className = 'slider';

        const toggleLabel = document.createElement('span');
        toggleLabel.className = 'toggle-label';
        toggleLabel.textContent = beer.on_tap ? 'On tap' : 'Not on';

        label.appendChild(input);
        label.appendChild(slider);
        toggleDiv.appendChild(label);
        toggleDiv.appendChild(toggleLabel);
        metaRow.appendChild(toggleDiv);
      } else {
        const pill = document.createElement('div');
        pill.className = beer.on_tap ? 'on-tap' : 'pill';
        pill.textContent = beer.on_tap ? 'On tap' : 'Not on';
        metaRow.appendChild(pill);
      }

      card.appendChild(metaRow);

      // Description
      if(beer.description){
        const desc = document.createElement('p');
        desc.style = 'margin-top:8px; color:var(--muted); font-size:0.95rem';
        desc.textContent = beer.description;
        card.appendChild(desc);
      }

      // Sizes
      if(beer.sizes && beer.sizes.length){
        const sizesDiv = document.createElement('div');
        sizesDiv.className = 'sizes';
        beer.sizes.forEach(s => {
          const sizeEl = document.createElement('div');
          sizeEl.className = 'size';
          sizeEl.textContent = `${s.label} — $${Number(s.price).toFixed(2)}`;
          sizesDiv.appendChild(sizeEl);
        });
        card.appendChild(sizesDiv);
      }

      // Tags
      if(beer.tags && beer.tags.length){
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'tags';
        beer.tags.forEach(t => {
          const tagEl = document.createElement('span');
          tagEl.className = 'tag';
          tagEl.textContent = t;
          tagsDiv.appendChild(tagEl);
        });
        card.appendChild(tagsDiv);
      }

      beerGrid.appendChild(card);
    }
  }

  // ---- Search (debounced) ----
  let debounceTimer;
  searchEl.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      if(!taplist) return;
      const term = searchEl.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const filteredBeers = (taplist.beers||[]).filter(beer=>{
        const name = (beer.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const style = (beer.style||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const tags = (beer.tags||[]).map(t=>t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""));
        return name.includes(term) || style.includes(term) || tags.some(tag=>tag.includes(term));
      });
      renderTaplist({...taplist, beers:filteredBeers});
    },200);
  });

  // ---- Refresh ----
  document.getElementById('refresh').addEventListener('click', () => {
    searchEl.value = '';
    fetch(API_URL)
      .then(r => r.json())
      .then(data => renderTaplist(data))
      .catch(err => console.error('Failed to fetch taplist.json', err));
  });

  // ---- Admin login modal ----
  adminBtn.addEventListener('click', () => {
    adminModal.style.display = 'flex';
  });

  document.getElementById('adminLoginBtn').onclick = async () => {
    const input = document.getElementById('adminPasswordInput').value;
    const inputHash = await sha256(input);
    const ADMIN_PASSWORD_HASH = "fa9fdcce5d12f32fd2018b3ca1299fea52be175ed53930e04203a4eed7480158"; // hash of "beertastegood"

    if(inputHash === ADMIN_PASSWORD_HASH){
      isAdmin = true;
      sessionStorage.setItem('isAdmin','true');
      adminModal.style.display = 'none';
      renderTaplist(taplist);
      adminBtn.style.display = 'none';
    } else {
      document.getElementById('adminLoginError').style.display = 'block';
    }
  };

  // ---- Initial fetch + WebSocket ----
  fetch(API_URL)
    .then(r=>r.json())
    .then(renderTaplist)
    .catch(err => console.error('Failed to fetch taplist.json', err));

  function connectSocket(){
    const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socket = new WebSocket(`${wsProto}//${location.host}`);
    socket.onmessage = e => {
      const msg = JSON.parse(e.data);
      if(msg.type==='taplist-update') renderTaplist(msg.taplist);
    };
    socket.onclose = () => setTimeout(connectSocket,3000);
  }
  connectSocket();

  // ---- PWA service worker ----
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg=>console.log('Service worker registered:',reg.scope))
        .catch(err=>console.error('Service worker registration failed:',err));
    });
  }
});
</script>
</body>
</html>

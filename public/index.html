<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#6b3e1b" />
<title>Prairie Sun Brewery — Live Taplist</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json" />

<!-- Favicon -->
<link rel="icon" href="icons/icon-192.png" sizes="192x192" />

<!-- iOS Home Screen -->
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<meta name="apple-mobile-web-app-title" content="Prairie Sun">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root {
  --bg:#fbfbfb; 
  --card:#fff; 
  --accent:#6b3e1b; 
  --muted:#666; 
  --gap:12px;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Default / Desktop styles */
html, body {
  height: 100%;
  margin: 0;
  background: var(--bg);
  color: #111;
}
.container {
  padding: 14px;
  max-width: 900px;
  margin: 0 auto; /* centers container */
  overflow: visible; /* let grid expand */
  flex: none; /* disable mobile flex adjustments */
}

/* Header */
header {
  background: linear-gradient(90deg,var(--accent),#8b5a32);
  color: white;
  padding: 18px 14px;
}
header h1 { margin: 0; font-size: 1.15rem; letter-spacing: 0.6px; }
header p { margin: 6px 0 0 0; font-size: 0.9rem; opacity: 0.95; }

/* Meta / Search */
.meta { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.meta .updated { color: var(--muted); font-size: 0.9rem; }
input[type=search] { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; width: 100%; max-width: 340px; }

/* Grid & Cards */
.grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap: var(--gap); }
.card { background: var(--card); border-radius: 12px; padding: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
.card h3 { margin: 0; font-size: 1.02rem; }
.meta-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
.pill { background: #eee; padding: 4px 8px; border-radius: 999px; font-size: 0.85rem; }
.on-tap { background: #dff5e1; color: #196619; font-weight: 600; padding: 4px 8px; border-radius: 8px; }
.tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
.tag { font-size: 0.78rem; color: var(--muted); background: #f6f6f6; padding: 4px 8px; border-radius: 999px; }
.sizes { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
.size { font-weight: 700; }
footer { padding: 12px; color: var(--muted); text-align: center; font-size: 0.9rem; }
.tv-note { display: none; }

@media (min-width:900px){
  header h1 { font-size: 1.35rem; }
  .tv-note { display: block; font-size: 0.9rem; color: #fff; opacity: 0.9; }
}

/* iPhone / PWA safe-area adjustments */
@media (max-width: 900px) and (orientation: portrait) {
  @supports (padding: max(env(safe-area-inset-top))) {
    html, body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
      overflow: hidden;
    }
    header {
      padding: calc(18px + env(safe-area-inset-top)) 14px 18px 14px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .container {
      flex: 1 1 auto;
      overflow-y: auto;
      max-width: 100%;
      margin: 0;
    }
  }
}

/* iPhone-style toggle */
.toggle { position: relative; display: inline-block; width: 50px; height: 28px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left:0; right:0; bottom:0; background-color: #ccc; transition: 0.4s; border-radius: 28px; }
.slider:before { position: absolute; content:""; height:22px; width:22px; left:3px; bottom:3px; background:white; transition:0.4s; border-radius:50%; }
.toggle input:checked + .slider { background-color: #4caf50; }
.toggle input:checked + .slider:before { transform: translateX(22px); }
.toggle-label { margin-left: 6px; font-size: 0.85rem; color: var(--muted); }

/* Admin Login Modal */
#adminLoginModal {
  display: none;
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  justify-content: center; align-items: center;
}
#adminLoginModalContent {
  background: #fff; padding: 20px; border-radius: 12px; max-width: 300px; width: 90%;
  display: flex; flex-direction: column; gap: 12px;
}
#adminLoginError { color: red; display: none; font-size: 0.9rem; }
</style>


</head>
<body>

<header>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; max-width:900px; margin:0 auto;">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="icons/icon-192.png" alt="Prairie Sun Brewery Logo" style="height:50px; width:auto; border-radius:6px;" />
      <div>
        <h1>Prairie Sun Brewery — Live Taplist</h1>
        <p class="tv-note">Open the menu on a phone — staff can update taps in seconds.</p>
      </div>
    </div>
    <button id="adminBtn" style="padding:6px 12px; border-radius:6px; border:none; background:var(--accent); color:white; cursor:pointer;">Admin</button>
  </div>
</header>

<div class="container">
  <div class="meta">
    <div>
      <div class="venue" id="venueName">Prairie Sun Brewery</div>
      <div class="updated" id="lastUpdated">Updated: —</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="search" type="search" placeholder="Search beers, styles, tags, or producer" />
      <button id="refresh">Refresh</button>
    </div>
  </div>

  <div id="beerGrid" class="grid" aria-live="polite"></div>

  <footer>
    <div id="status">Loading menu…</div>
    <div style="margin-top:6px; font-size:0.85rem">Scan QR around the taproom for this live menu.</div>
  </footer>
</div>

<!-- Admin login modal -->
<div id="adminLoginModal">
  <div id="adminLoginModalContent">
    <h3>Admin Login</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter password" />
    <button id="adminLoginBtn">Login</button>
    <div id="adminLoginError">Incorrect password</div>
  </div>
</div>

<!-- Admin Taplist Management Panel -->
<div id="adminPanel" class="card" style="display:none; margin-top:14px;">
  <h3 style="margin-bottom:12px;">Manage Taplist</h3>
  <button id="addBeerBtn" class="pill">+ Add Beer</button>
  <div id="beerList" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
  <button id="saveTaplistBtn" class="pill" style="margin-top:14px; background: var(--accent); color:white;">Save Changes</button>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = 'taplist.json';
  const beerGrid = document.getElementById('beerGrid');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const venueNameEl = document.getElementById('venueName');
  const searchEl = document.getElementById('search');
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminLoginModal');

  let taplist = null;
  let isAdmin = sessionStorage.getItem('isAdmin') === 'true';
  let pendingUpdates = {};

  function escapeHtml(s) {
    return (s === undefined || s === null) ? '' : String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  window.handleToggle = (beerId, onTap) => {
    pendingUpdates[beerId] = onTap;
    const label = document.querySelector(`#beer-${beerId} .toggle-label`);
    if (label) label.textContent = onTap ? 'On tap' : 'Not on';
  }

// --- Update or create single beer card ---
function upsertBeerCard(beer) {
  let card = document.getElementById(`beer-${beer.id}`);

  const toggleHTML = isAdmin ? `
    <div style="margin-top:8px; display:flex; align-items:center; gap:8px">
      <label class="toggle">
        <input type="checkbox" ${beer.on_tap ? 'checked' : ''} onchange="handleToggle('${beer.id}', this.checked)" />
        <span class="slider"></span>
      </label>
      <span class="toggle-label">${beer.on_tap ? 'On tap' : 'Not on'}</span>
    </div>` :
    (beer.on_tap ? `<div class="on-tap">On tap</div>` : `<div class="pill">Not on</div>`);

  const innerHTML = `
    <h3>${escapeHtml(beer.name)}${beer.style ? `<span style="font-weight:400; font-size:0.86rem; color:var(--muted)">— ${escapeHtml(beer.style)}</span>` : ''}</h3>
    <div style="font-size:0.85rem; color:var(--muted); margin-top:2px">
      ${escapeHtml(beer.producer || '')}${beer.location ? ', ' + escapeHtml(beer.location) : ''}
    </div>
    <div class="meta-row">
      <div class="pill">ABV: ${beer.abv ?? '—'}%</div>
      ${beer.ibu ? `<div class="pill">IBU: ${beer.ibu}</div>` : ''}
      ${toggleHTML}
    </div>
    <p style="margin-top:8px; color:var(--muted); font-size:0.95rem">${escapeHtml(beer.description || '')}</p>
    <div class="sizes">${(beer.sizes || []).map(s => `<div class="size">${escapeHtml(s.label)} — $${Number(s.price).toFixed(2)}</div>`).join('')}</div>
    <div class="tags">${(beer.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
  `;

  if (!card) {
    card = document.createElement('article');
    card.id = `beer-${beer.id}`;
    card.className = 'card';
    beerGrid.appendChild(card);
  }

  card.innerHTML = innerHTML;

  // --- Prairie Sun special styling ---
  if (beer.producer === "Prairie Sun Brewery") {
    card.style.border = '2px solid var(--accent)';
    card.style.position = 'relative';
    card.style.overflow = 'hidden';

    // Remove previous overlay/logo if exists
    let overlay = card.querySelector('.ps-overlay');
    if (overlay) overlay.remove();

    // Add faded logo near right middle
	overlay = document.createElement('div');
	overlay.className = 'ps-overlay';
	overlay.style.position = 'absolute';
	overlay.style.width = '25%';        // smaller logo
	overlay.style.height = '50%';       // fixed height so it displays
	overlay.style.top = '50%';          // vertical center
	overlay.style.right = '10%';        // distance from right edge
	overlay.style.transform = 'translateY(-50%)'; // center vertically
	overlay.style.backgroundImage = 'url("images/prairie-sun-light-logo.PNG")';
	overlay.style.backgroundSize = 'contain';
	overlay.style.backgroundRepeat = 'no-repeat';
	overlay.style.backgroundPosition = 'center';
	overlay.style.opacity = '0.15';     // faint watermark
	overlay.style.pointerEvents = 'none'; // don't block clicks
	overlay.style.zIndex = '0';
	card.appendChild(overlay);


    // Ensure text is above overlay
    card.querySelectorAll(':scope > *:not(.ps-overlay)').forEach(el => el.style.position = 'relative');
  } else {
    // Reset any previous Prairie Sun styling
    card.style.border = '';
    card.style.position = '';
    card.style.overflow = '';
  }
}


  function renderTaplist(data, filterTerm='') {
    if(!data) return;
    taplist = data;
    venueNameEl.textContent = data.meta?.venue ?? 'Prairie Sun Brewery';
    lastUpdatedEl.textContent = 'Updated: ' + (data.meta?.last_updated ?? '—');

    let beersToShow = data.beers || [];
    if(filterTerm){
      const term = filterTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      beersToShow = beersToShow.filter(beer=>{
        const name = (beer.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const style = (beer.style||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const tags = (beer.tags||[]).map(t=>t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""));
	 const producer = (beer.producer||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        return name.includes(term) || style.includes(term) || tags.some(tag=>tag.includes(term))||
           producer.includes(term);
      });
    }

    beerGrid.innerHTML = '';
    beersToShow.forEach(beer => upsertBeerCard(beer));
  }

  let debounceTimer;
  searchEl.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      if(!taplist) return;
      renderTaplist(taplist, searchEl.value);
    }, 200);
  });

  document.getElementById('refresh').addEventListener('click', () => {
    searchEl.value = '';
    fetch(API_URL).then(r=>r.json()).then(data=>{
      renderTaplist(data);
    }).catch(err=>console.error('Failed to fetch taplist.json', err));
  });

  adminBtn.addEventListener('click', () => {
    adminModal.style.display='flex';
    addAdminExitButton();
  });

  document.getElementById('adminPasswordInput').addEventListener('keydown', async (e) => {
    if(e.key === 'Enter'){
      document.getElementById('adminLoginBtn').click();
    }
  });

  document.getElementById('adminLoginBtn').onclick = async () => {
    const input = document.getElementById('adminPasswordInput').value;
    const inputHash = await sha256(input);
    const ADMIN_PASSWORD_HASH = "fa9fdcce5d12f32fd2018b3ca1299fea52be175ed53930e04203a4eed7480158";
    if(inputHash===ADMIN_PASSWORD_HASH){
      isAdmin = true;
      sessionStorage.setItem('isAdmin','true');
      adminModal.style.display='none';
      adminBtn.style.display='none';
      renderTaplist(taplist);
      addSaveButton();
      addAdminModeExitButton();
      // NEW: show admin panel
      document.getElementById('adminPanel').style.display = 'block';
      renderAdminCards();
    } else {
      document.getElementById('adminLoginError').style.display='block';
    }
  };

  function addSaveButton(){
    let saveBtn = document.getElementById('saveBtn');
    if(!saveBtn){
      saveBtn = document.createElement('button');
      saveBtn.id = 'saveBtn';
      saveBtn.textContent = 'Save Changes';
      saveBtn.style.cssText = `
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        background: var(--accent);
        color: white;
        cursor: pointer;
        margin-left: 8px;
      `;
      adminBtn.parentNode.insertBefore(saveBtn, adminBtn.nextSibling);

      saveBtn.onclick = async () => {
        if(Object.keys(pendingUpdates).length === 0) return alert('No changes to save.');
        try {
          const res = await fetch('/save-taplist', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ updates: pendingUpdates })
          });
          const data = await res.json();
          if(data.success){
            alert('Changes saved!');
            pendingUpdates = {};
            renderTaplist(taplist, searchEl.value);
          } else {
            alert('Failed to save changes.');
          }
        } catch(err){
          console.error(err);
          alert('Error saving changes.');
        }
      };
    }
    saveBtn.style.display = 'inline-block';
  }
  
  function renderAdminCards() {
  const container = document.getElementById('beerList');
  container.innerHTML = '';

  (taplist.beers || []).forEach((beer, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.gap = '6px';
    
    card.innerHTML = `
      <input type="text" placeholder="Name" value="${beer.name || ''}" data-index="${index}" data-field="name" />
      <input type="text" placeholder="Style" value="${beer.style || ''}" data-index="${index}" data-field="style" />
      <input type="text" placeholder="Producer" value="${beer.producer || ''}" data-index="${index}" data-field="producer" />
      <input type="text" placeholder="Tags (comma-separated)" value="${(beer.tags||[]).join(', ')}" data-index="${index}" data-field="tags" />
      <label style="display:flex; align-items:center; gap:6px;">
        On Tap:
        <input type="checkbox" ${beer.on_tap ? 'checked' : ''} data-index="${index}" data-field="on_tap" />
      </label>
      <button class="pill" style="background:#ff6666; color:white;" data-index="${index}" data-action="delete">Delete</button>
    `;

    container.appendChild(card);
  });

  // Input and delete listeners
  container.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', handleBeerInputChange);
    input.addEventListener('change', handleBeerInputChange);
  });

  container.querySelectorAll('button[data-action="delete"]').forEach(btn => {
    btn.addEventListener('click', handleDeleteBeer);
  });
}

// input change handler
function handleBeerInputChange(e) {
  const index = e.target.dataset.index;
  const field = e.target.dataset.field;
  if(field === 'on_tap') {
    taplist.beers[index][field] = e.target.checked;
  } else if(field === 'tags') {
    taplist.beers[index][field] = e.target.value.split(',').map(t => t.trim());
  } else {
    taplist.beers[index][field] = e.target.value;
  }
}

// delete beer
function handleDeleteBeer(e) {
  const index = e.target.dataset.index;
  if(confirm('Are you sure you want to delete this beer?')) {
    taplist.beers.splice(index,1);
    renderAdminCards();
  }
}

// add new beer
document.getElementById('addBeerBtn').addEventListener('click', () => {
  taplist.beers.push({
    name: '',
    style: '',
    producer: '',
    tags: [],
    on_tap: false
  });
  renderAdminCards();
});

// save taplist
document.getElementById('saveTaplistBtn').addEventListener('click', async () => {
  try {
    taplist.meta.last_updated = new Date().toISOString();
    const res = await fetch('/updateTaplist', {  // your backend endpoint
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(taplist)
    });
    if(res.ok){
      alert('Taplist saved successfully!');
      renderTaplist(taplist);
    } else {
      alert('Failed to save taplist.');
    }
  } catch(err) {
    console.error(err);
    alert('Error saving taplist.');
  }
});

  function addAdminExitButton() {
    let modalExit = document.getElementById('modalExitBtn');
    if (!modalExit) {
      modalExit = document.createElement('button');
      modalExit.id = 'modalExitBtn';
      modalExit.textContent = 'Exit';
      modalExit.style.cssText = `
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        background: var(--accent);
        color: white;
        cursor: pointer;
        margin-top: 8px;
        display: block;
      `;
      const modalContent = document.getElementById('adminLoginModalContent');
      modalContent.appendChild(modalExit);

      modalExit.onclick = () => {
        adminModal.style.display = 'none';
        document.getElementById('adminPasswordInput').value = '';
        document.getElementById('adminLoginError').style.display = 'none';
      };
    }
    modalExit.style.display = 'inline-block';
  }

function addAdminModeExitButton() {
  let exitBtn = document.getElementById('exitBtn');
  if (!exitBtn) {
    exitBtn = document.createElement('button');
    exitBtn.id = 'exitBtn';
    exitBtn.textContent = 'Exit Admin';
    exitBtn.style.cssText = `
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      margin-left: 8px;
    `;
    // Insert after Save button
    adminBtn.parentNode.insertBefore(exitBtn, document.getElementById('saveBtn').nextSibling);

    exitBtn.onclick = () => {
      // Exit admin mode
      isAdmin = false;
      sessionStorage.removeItem('isAdmin');

      // Hide admin-specific buttons and panel
      exitBtn.style.display = 'none';
      document.getElementById('saveBtn').style.display = 'none';
      adminBtn.style.display = 'inline-block';
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) adminPanel.style.display = 'none';

      // Re-render taplist as normal user
      renderTaplist(taplist, searchEl.value);
    };
  }
  exitBtn.style.display = 'inline-block';
}


  fetch(API_URL).then(r=>r.json()).then(data=>{
    renderTaplist(data);
    if(isAdmin){
      addSaveButton();
      addAdminModeExitButton();
    }
  }).catch(err=>console.error(err));

  function connectSocket(){
    const wsProto = location.protocol==='https:'?'wss:':'ws:';
    const socket = new WebSocket(`${wsProto}//${location.host}`);
    socket.onmessage = e => {
      const msg = JSON.parse(e.data);
      if(msg.type==='taplist-update') renderTaplist(msg.taplist, searchEl.value);
    };
    socket.onclose = ()=>setTimeout(connectSocket,3000);
  }
  connectSocket();

  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js')
      .then(reg=>console.log('Service worker registered:',reg.scope))
      .catch(err=>console.error('Service worker registration failed:',err))
    );
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#6b3e1b" />
<title>Prairie Sun Brewery — Live Taplist</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json" />

<!-- Favicon -->
<link rel="icon" href="icons/icon-192.png" sizes="192x192" />

<!-- iOS Home Screen -->
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<meta name="apple-mobile-web-app-title" content="Prairie Sun">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- External CSS -->
<link rel="stylesheet" href="style.css">

<!-- Inline CSS for minimal page-specific adjustments -->
<style>
:root {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --gap: 12px;
}

/* Header styling */
header {
  background: linear-gradient(90deg, #6b3e1b, #8b5a32);
  color: white;
  padding: 18px 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}
header h1 { margin: 0; font-size: 1.15rem; letter-spacing: 0.6px; }
header p { margin: 6px 0 0 0; font-size: 0.9rem; opacity: 0.95; }

/* Meta / Search */
.meta { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.meta .updated { color: #666; font-size: 0.9rem; }
input[type=search] { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; width: 100%; max-width: 340px; }

/* Grid & Cards */
.grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap: var(--gap); }
.card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); position: relative; }
.card h3 { margin: 0; font-size: 1.02rem; }
.meta-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
.pill { background: #eee; padding: 4px 8px; border-radius: 999px; font-size: 0.85rem; }
.on-tap { background: #dff5e1; color: #196619; font-weight: 600; padding: 4px 8px; border-radius: 8px; }
.tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
.tag { font-size: 0.78rem; color: #666; background: #f6f6f6; padding: 4px 8px; border-radius: 999px; }
.sizes { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
.size { font-weight: 700; }

/* Footer */
footer { padding: 12px; color: #666; text-align: center; font-size: 0.9rem; }
.tv-note { display: none; }

@media (min-width:900px){
  header h1 { font-size: 1.35rem; }
  .tv-note { display: block; font-size: 0.9rem; color: #fff; opacity: 0.9; }
}

/* iPhone / PWA safe-area adjustments */
@media (max-width: 900px) and (orientation: portrait) {
  @supports (padding: max(env(safe-area-inset-top))) {
    html, body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
    }
    .container {
      flex: 1 1 auto;
      overflow-y: auto;
      max-width: 100%;
      margin: 0;
    }
  }
}

/* Admin Login Modal (no duplication) */
#adminLoginModal {
  display: none;
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  justify-content: center; align-items: center;
}
#adminLoginModalContent {
  background: #fff; padding: 20px; border-radius: 12px; max-width: 300px; width: 90%;
  display: flex; flex-direction: column; gap: 12px;
}
#adminLoginError { color: red; display: none; font-size: 0.9rem; }
</style>
</head>
<body>

<header>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; max-width:900px; margin:0 auto;">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="icons/icon-192.png" alt="Prairie Sun Brewery Logo" style="height:50px; width:auto; border-radius:6px;" />
      <div>
        <h1>Prairie Sun Brewery — Live Taplist</h1>
        <p class="tv-note">Open the menu on a phone — staff can update taps in seconds.</p>
      </div>
    </div class="header-buttons">
      <button id="adminBtn" style="padding:6px 12px; border-radius:6px; border:none; background:var(--accent); color:white; cursor:pointer;">Admin</button>
      <button id="saveTaplistBtn" style="padding:6px 12px; border-radius:6px; border:none; background:var(--accent); color:white; cursor:pointer;">Save Changes</button>
      <button id="exitAdminBtn" style="padding:6px 12px; border-radius:6px; border:none; background:var(--accent); color:white; cursor:pointer;">Exit Admin</button>
  </div>
</header>

<div class="container">
  <div class="meta">
    <div>
      <div class="venue" id="venueName">Prairie Sun Brewery</div>
      <div class="updated" id="lastUpdated">Updated: —</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="search" type="search" placeholder="Search beers, styles, tags, or producer" />
      <button id="refresh">Refresh</button>
    </div>
  </div>

  <!-- BEER GRID (always present) -->
  <div id="beerGrid" class="grid" aria-live="polite"></div>

  <!-- ADMIN PANEL (only visible in admin mode) -->
  <div id="adminPage">
    <div id="adminPanelHeader">
      <button id="addBeerBtn">+ Add Beer</button>
    </div>
    <div id="adminBeerList"></div>
  </div>

  <footer>
    <div id="status">Loading menu…</div>
    <div style="margin-top:6px; font-size:0.85rem">Scan QR around the taproom for this live menu.</div>
  </footer>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="adminLoginModal">
  <div id="adminLoginModalContent">
    <h3>Admin Login</h3>
    <input type="password" id="adminPasswordInput" placeholder="Enter password" />
    <button id="adminLoginBtn">Login</button>
    <div id="adminLoginError">Incorrect password</div>
    <button id="modalExitBtn">Exit</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = 'taplist.json';

  const beerGrid = document.getElementById('beerGrid');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const venueNameEl = document.getElementById('venueName');
  const searchEl = document.getElementById('search');
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminLoginModal');
  const adminPanel = document.getElementById('adminPage');
  const adminBeerList = document.getElementById('adminBeerList');
  const addBeerBtn = document.getElementById('addBeerBtn');
  const saveTaplistBtn = document.getElementById('saveTaplistBtn');
  const exitAdminBtn = document.getElementById('exitAdminBtn');

  let taplist = null;
  let isAdmin = sessionStorage.getItem('isAdmin') === 'true';
  let pendingUpdates = {};
  let deletedBeerIds = [];

  // --- Utilities ---
  function escapeHtml(s) {
    return (s === undefined || s === null) ? '' :
      String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // --- Beer card creation/update ---
  function upsertBeerCard(beer) {
    let card = document.getElementById(`beer-${beer.id}`);

    const toggleHTML = isAdmin ? `
      <div class="toggle-container">
        <label class="toggle">
          <input type="checkbox" ${beer.on_tap ? 'checked' : ''} 
                 onchange="handleToggle('${beer.id}', this.checked)" />
          <span class="slider"></span>
        </label>
        <span class="toggle-label">${beer.on_tap ? 'On tap' : 'Not on'}</span>
      </div>` :
      `<div class="${beer.on_tap ? 'pill on-tap' : 'pill not-on'}">
        ${beer.on_tap ? 'On tap' : 'Not on'}
      </div>`;

    const innerHTML = `
      <h3>${escapeHtml(beer.name)}
        ${beer.style ? `<span style="font-weight:400; font-size:0.86rem; color:var(--muted)"> — ${escapeHtml(beer.style)}</span>` : ''}
      </h3>
      <div style="font-size:0.85rem; color:var(--muted); margin-top:2px">
        ${escapeHtml(beer.producer || '')}${beer.location ? ', ' + escapeHtml(beer.location) : ''}
      </div>
      <div class="meta-row">
        <div class="pill">ABV: ${beer.abv ?? '—'}%</div>
        ${beer.ibu ? `<div class="pill">IBU: ${beer.ibu}</div>` : ''}
      </div>
      ${toggleHTML}
      <p style="margin-top:8px; color:var(--muted); font-size:0.95rem">
        ${escapeHtml(beer.description || '')}
      </p>
      <div class="sizes">
        ${(beer.sizes || []).map(s => `<div class="size">${escapeHtml(s.label)} — $${Number(s.price).toFixed(2)}</div>`).join('')}
      </div>
      <div class="tags">
        ${(beer.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}
      </div>
    `;

    if (!card) {
      card = document.createElement('article');
      card.id = `beer-${beer.id}`;
      card.className = 'card';
      beerGrid.appendChild(card);
    }

    card.innerHTML = innerHTML;

    // Special styling for Prairie Sun Brewery
    if (beer.producer === "Prairie Sun Brewery") {
      card.style.border = '2px solid var(--accent)';
      card.style.position = 'relative';
      card.style.overflow = 'hidden';

      let overlay = card.querySelector('.ps-overlay');
      if (overlay) overlay.remove();

      overlay = document.createElement('div');
      overlay.className = 'ps-overlay';
      card.appendChild(overlay);

      card.querySelectorAll(':scope > *:not(.ps-overlay)').forEach(el => el.style.position = 'relative');
    } else {
      card.style.border = '';
      card.style.position = '';
      card.style.overflow = '';
    }
  }

  // --- Render taplist ---
  function renderTaplist(filterTerm='') {
    if (!taplist) return;
    venueNameEl.textContent = taplist.meta?.venue ?? 'Prairie Sun Brewery';
    lastUpdatedEl.textContent = 'Updated: ' + (taplist.meta?.last_updated ?? '—');

    let beersToShow = taplist.beers || [];
    if (filterTerm) {
      const term = filterTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      beersToShow = beersToShow.filter(beer => {
        const name = (beer.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const style = (beer.style||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const tags = (beer.tags||[]).map(t=>t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""));
        const producer = (beer.producer||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        return name.includes(term) || style.includes(term) || tags.some(tag=>tag.includes(term)) || producer.includes(term);
      });
    }

    beerGrid.innerHTML = '';
    beersToShow.forEach(upsertBeerCard);
  }

function renderAdminBeerInputs() {
  adminBeerList.innerHTML = '';

  // Sort beers by sort_order before rendering
  const sortedBeers = (taplist.beers || []).slice().sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

  sortedBeers.forEach((beer, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.gap = '6px';

    const sizesHTML = (beer.sizes || []).map((s, i) => `
      <div style="display:flex; gap:4px; align-items:center;">
        <input type="text" placeholder="Size label" value="${s.label}" data-index="${index}" data-field="sizes-label-${i}" style="flex:1;" />
        <input type="number" placeholder="Price" value="${s.price}" data-index="${index}" data-field="sizes-price-${i}" style="width:70px;" />
        <button type="button" class="remove-size-btn" data-index="${index}" data-size="${i}">Remove</button>
      </div>
    `).join('');

    card.innerHTML = `
      <input type="text" placeholder="Name" value="${beer.name || ''}" data-index="${index}" data-field="name" />
      <input type="text" placeholder="Style" value="${beer.style || ''}" data-index="${index}" data-field="style" />
      <input type="text" placeholder="Producer" value="${beer.producer || ''}" data-index="${index}" data-field="producer" />
      <input type="text" placeholder="Location" value="${beer.location || ''}" data-index="${index}" data-field="location" />
      <input type="text" placeholder="ABV" value="${beer.abv || ''}" data-index="${index}" data-field="abv" />
      <input type="text" placeholder="IBU" value="${beer.ibu || ''}" data-index="${index}" data-field="ibu" />
      <textarea placeholder="Description" data-index="${index}" data-field="description">${beer.description || ''}</textarea>
      <input type="text" placeholder="Tags (comma-separated)" value="${(beer.tags || []).join(', ')}" data-index="${index}" data-field="tags" />
      <div style="display:flex; gap:6px; align-items:center;">
        <label>On Tap: <input type="checkbox" data-index="${index}" data-field="on_tap" ${beer.on_tap ? 'checked' : ''} /></label>
      </div>
      <div>
        <label>Sizes:</label>
        ${sizesHTML}
        <button type="button" class="add-size-btn" data-index="${index}">+ Add Size</button>
      </div>
      <input type="text" placeholder="Price Note" value="${beer.price_note || ''}" data-index="${index}" data-field="price_note" />
      <div style="display:flex; gap:6px;">
        <button class="admin-btn" data-index="${index}" data-action="delete">Delete</button>
        <button class="move-up" data-index="${index}">↑</button>
        <button class="move-down" data-index="${index}">↓</button>
      </div>
    `;

    adminBeerList.appendChild(card);
  });

  // --- Event delegation for inputs ---
  adminBeerList.addEventListener('input', handleBeerInputChange);
  adminBeerList.addEventListener('change', handleBeerInputChange);

  // --- Event delegation for buttons ---
  adminBeerList.addEventListener('click', e => {
    const btn = e.target;
    const index = parseInt(btn.dataset.index);
    const beer = sortedBeers[index];
    if (!beer) return;

    // Delete beer
    if (btn.dataset.action === 'delete') {
      if (confirm('Are you sure you want to delete this beer?')) {
        deletedBeerIds.push(beer.id);
        const beerIndex = taplist.beers.findIndex(b => b.id === beer.id);
        if (beerIndex !== -1) taplist.beers.splice(beerIndex, 1);
        renderAdminBeerInputs();
        renderTaplist();
      }
    }

    // Add size
    else if (btn.classList.contains('add-size-btn')) {
      if (!beer.sizes) beer.sizes = [];
      beer.sizes.push({ label: '', price: 0 });
      renderAdminBeerInputs();
    }

    // Remove size
    else if (btn.classList.contains('remove-size-btn')) {
      const sizeIndex = parseInt(btn.dataset.size);
      if (beer.sizes && beer.sizes[sizeIndex] !== undefined) {
        beer.sizes.splice(sizeIndex, 1);
        renderAdminBeerInputs();
      }
    }

    // Move Up
    else if (btn.classList.contains('move-up')) {
      const beerIndex = taplist.beers.findIndex(b => b.id === beer.id);
      if (beerIndex > 0) {
        const prevBeer = taplist.beers[beerIndex - 1];
        [beer.sort_order, prevBeer.sort_order] = [prevBeer.sort_order, beer.sort_order];
        renderAdminBeerInputs();
        renderTaplist();
      }
    }

    // Move Down
    else if (btn.classList.contains('move-down')) {
      const beerIndex = taplist.beers.findIndex(b => b.id === beer.id);
      if (beerIndex < taplist.beers.length - 1) {
        const nextBeer = taplist.beers[beerIndex + 1];
        [beer.sort_order, nextBeer.sort_order] = [nextBeer.sort_order, beer.sort_order];
        renderAdminBeerInputs();
        renderTaplist();
      }
    }
  });
}


  // --- Add beer ---
addBeerBtn.onclick = () => {
  const nextSortOrder = (taplist.beers.length > 0)
    ? Math.max(...taplist.beers.map(b => b.sort_order || 0)) + 10
    : 10;

  const newBeer = {
    id: `new-beer-${Date.now()}`, // temporary unique ID
    name: '',
    style: '',
    producer: '',
    location: '',
    abv: '',
    ibu: '',
    sizes: [
      { label: "Tulip", price: 0 },
      { label: "Pint", price: 0 },
      { label: "Pitcher", price: 0 }
    ],
    price_note: '',
    description: '',
    tags: [],
    on_tap: true,       // default to ON TAP
    image: '',
    sort_order: nextSortOrder
  };

  taplist.beers.push(newBeer);
  renderAdminBeerInputs();
  renderTaplist();
};

  function handleDeleteBeer(e) {
  const index = e.target.dataset.index;
  const beer = taplist.beers[index];
  if (!beer) return;

  // Add to deleted list
  deletedBeerIds.push(beer.id);

  // Remove from taplist array
  taplist.beers.splice(index, 1);

  // Re-render admin inputs and main taplist
  renderAdminBeerInputs();
  renderTaplist();
}
  
saveTaplistBtn.onclick = async () => {
  try {
    const updates = {};
    (taplist.beers || []).forEach(beer => {
      const original = pendingUpdates[beer.id] || {};
      const changedFields = {};
      ['name','style','producer','location','abv','ibu','tags','on_tap','sizes','description','price_note'].forEach(field => {
        const value = beer[field];
        const origValue = original[field];
        if (Array.isArray(value) && Array.isArray(origValue)) {
          if (value.join(',') !== origValue.join(',')) changedFields[field] = value;
        } else if (value !== origValue) {
          changedFields[field] = value;
        }
      });
      if (Object.keys(changedFields).length > 0) updates[beer.id] = changedFields;
    });

    if (Object.keys(updates).length === 0 && deletedBeerIds.length === 0) {
      alert('No changes to save!');
      return;
    }

    taplist.meta.last_updated = new Date().toISOString();

    const res = await fetch('/save-taplist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ updates, delete: deletedBeerIds }) // <-- send deletions
    });

    if (res.ok) {
      alert('Taplist saved successfully!');
      pendingUpdates = {};
      deletedBeerIds = [];
      renderTaplist();
      renderAdminBeerInputs();
    } else {
      const data = await res.json();
      alert(`Failed to save taplist: ${data.message || res.statusText}`);
    }
  } catch (err) {
    console.error(err);
    alert('Error saving taplist.');
  }
};

  // --- Exit Admin ---
  exitAdminBtn.onclick = () => {
    isAdmin = false;
    sessionStorage.removeItem('isAdmin');
    document.body.classList.remove('admin-mode'); // hides Save / Exit buttons
    adminPanel.style.display = 'none';
    renderTaplist();
  }

  // -- Enter Admin ---
function enterAdminMode() {
  isAdmin = true;
  sessionStorage.setItem('isAdmin','true');

  // show admin panel buttons at top
  document.body.classList.add('admin-mode'); // shows Save / Exit buttons
  adminPanel.style.display = 'block';

  // ensure the main beer grid is visible
  beerGrid.style.display = 'grid';
  
  // Snapshot of current beers (deep copy)
  pendingUpdates = {};
  (taplist.beers || []).forEach(b => {
    pendingUpdates[b.id] = JSON.parse(JSON.stringify(b));
  });

  renderTaplist();
  renderAdminBeerInputs();
}

// --- Admin login ---
adminBtn.addEventListener('click', () => {
  adminModal.style.display = 'flex';
  const passwordInput = document.getElementById('adminPasswordInput');
  passwordInput.value = '';
  document.getElementById('adminLoginError').style.display = 'none';
  passwordInput.focus();
});

// --- Press Enter to log in ---
const passwordInput = document.getElementById('adminPasswordInput');
passwordInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault(); // prevent form submission / default behavior
    document.getElementById('adminLoginBtn').click();
  }
});

  // --- Password check ---
  document.getElementById('adminLoginBtn').onclick = async () => {
    const input = document.getElementById('adminPasswordInput').value;
    const inputHash = await sha256(input);
    const ADMIN_PASSWORD_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";
    if(inputHash===ADMIN_PASSWORD_HASH){
      adminModal.style.display = 'none';
      enterAdminMode();
    } else {
      document.getElementById('adminLoginError').style.display='block';
    }
  };

  document.getElementById('modalExitBtn').addEventListener('click', () => {
    adminModal.style.display='none';
  });

  document.addEventListener('keydown', e => {
    if(e.key==='Escape') adminModal.style.display='none';
  });

  // --- Beer toggle handler ---
  window.handleToggle = (beerId, onTap) => {
    const beer = taplist.beers.find(b => b.id === beerId);
    if (beer) {
      beer.on_tap = onTap;
      renderTaplist();
    }
  }

  // --- Search ---
  let debounceTimer;
  searchEl.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>renderTaplist(searchEl.value), 200);
  });

  // --- Refresh ---
  document.getElementById('refresh').addEventListener('click', () => {
    searchEl.value = '';
    fetch(API_URL).then(r=>r.json()).then(data=>renderTaplist(data)).catch(console.error);
  });
  
// --- Handle input changes ---
function handleBeerInputChange(e) {
  const index = parseInt(e.target.dataset.index);
  const field = e.target.dataset.field;
  const beer = taplist.beers[index];
  if (!beer) return;

  // Handle tags
  if (field === 'tags') {
    beer.tags = e.target.value.split(',').map(t => t.trim());
  }
  // Handle on_tap checkbox
  else if (field === 'on_tap') {
    beer.on_tap = e.target.checked;
  }
  // Handle sizes dynamically
  else if (field?.startsWith('sizes-')) {
    if (!beer.sizes) beer.sizes = [];

    // Match "sizes-label-0" or "sizes-price-1"
    const match = field.match(/^sizes-(label|price)-(\d+)$/);
    if (match) {
      const prop = match[1];      // "label" or "price"
      const i = parseInt(match[2]); // size index
      if (!beer.sizes[i]) beer.sizes[i] = { label: '', price: 0 };
      beer.sizes[i][prop] = prop === 'price' ? parseFloat(e.target.value) || 0 : e.target.value;
    }
  }
  // All other fields (name, style, producer, location, abv, ibu, description, price_note)
  else if (field) {
    beer[field] = e.target.value;
  }

  renderTaplist(); // update beer cards in real time
}


  // --- Initial load ---
  fetch(API_URL).then(r=>r.json()).then(data=>{
    taplist=data;
    renderTaplist();
    if(isAdmin) enterAdminMode();
  }).catch(console.error);

  // --- WebSocket for live updates ---
  function connectSocket(){
    const wsProto = location.protocol==='https:'?'wss:':'ws:';
    const socket = new WebSocket(`${wsProto}//${location.host}`);
    socket.onmessage = e => {
      const msg = JSON.parse(e.data);
      if(msg.type==='taplist-update'){
        taplist=msg.taplist;
        renderTaplist(searchEl.value);
      }
    };
    socket.onclose = ()=>setTimeout(connectSocket,3000);
  }
  connectSocket();

  // --- Service worker ---
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js')
      .then(reg=>console.log('Service worker registered:',reg.scope))
      .catch(err=>console.error('Service worker registration failed:',err))
    );
  }

});
</script>
</body>
</html>
